name: CI Pipeline
on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  lint:
    name: Lint Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup PNPM
        uses: pnpm/action-setup@v2
        with:
          version: 10.2.0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'pnpm'
          
      - name: Install Dependencies
        run: pnpm i
        
      - name: Run Lint
        run: pnpm run lint

  typecheck:
    name: Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup PNPM
        uses: pnpm/action-setup@v2
        with:
          version: 10.2.0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'pnpm'
          
      - name: Install Dependencies
        run: pnpm i
        
      - name: Run Type Check
        run: pnpm run typecheck

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [lint, typecheck]
    services:
      postgres:
        image: postgres:latest
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: blog_app_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4

      - name: Setup PNPM
        uses: pnpm/action-setup@v2
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'pnpm'
          
      - name: Install Dependencies
        run: pnpm i

      - name: Create environment files
        run: |
         
          # Create db .env
          cat > packages/db/.env << EOL
          DATABASE_URL=postgresql://postgres:postgres@localhost:5432/blog_app_test
          EOL
          
          # Create admin app .env - using secrets
          cat > apps/admin/.env << EOL
          ADMIN=${{ secrets.ADMIN_USERNAME }}
          PASSWORD=${{ secrets.ADMIN_PASSWORD }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          EOL
        
      - name: Setup Database Schema
        run: |
          cd packages/db
          pnpx prisma migrate deploy
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/blog_app_test

      - name: Build Web App
        run: pnpm run build --workspace=apps/web
        
      - name: Build Admin App
        run: pnpm run build --workspace=apps/admin
  
  playwright:
    name: Playwright Tests
    timeout-minutes: 60
    runs-on: ubuntu-latest
    needs: [build]
    services:
      postgres:
        image: postgres:latest
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: blog_app_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
    - uses: actions/checkout@v4
    - uses: pnpm/action-setup@v2
    - uses: actions/setup-node@v4
      with:
        node-version: 18
        cache: 'pnpm'

    - name: Install dependencies
      run: pnpm i

    - name: Create environment files
      run: |
        # Create db .env for Playwright tests
        cat > packages/db/.env << EOL
        DATABASE_URL=postgresql://postgres:postgres@localhost:5432/blog_app_test
        EOL
        
        # Create admin app .env - using secrets
        cat > apps/admin/.env << EOL
        ADMIN=${{ secrets.ADMIN_USERNAME }}
        PASSWORD=${{ secrets.ADMIN_PASSWORD }}
        JWT_SECRET=${{ secrets.JWT_SECRET }}
        EOL

    - name: Install Playwright Browsers
      run: pnpx playwright install --with-deps

    - name: Setup Database Schema for tests
      run: |
        cd packages/db
        pnpx prisma migrate deploy
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/blog_app_test
      
    - name: Run Playwright tests
      run: pnpm test-all
      
    - uses: actions/upload-artifact@v4
      if: ${{ always() }}
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 30

    - name: Notify on failure
      if: ${{ failure() }}
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: 'âŒ CI tests failed. Please check the [Playwright report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}).'
          })
